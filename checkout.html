<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Blaze city</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --checkout-bg: rgba(20, 20, 20, 0.95);
            --checkout-border: rgba(255, 255, 255, 0.1);
            --checkout-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            color: var(--light-text, #f6f6f6);
            background-color: #050505;
            position: relative;
            overflow-x: hidden;
        }

        .background-video {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            filter: brightness(0.4);
        }

        .checkout-layout {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 100px 20px 40px;
            position: relative;
            z-index: 1;
        }

        .checkout-container {
            max-width: 1000px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .checkout-form-section,
        .checkout-summary-section {
            background: var(--checkout-bg);
            border-radius: 20px;
            border: 1px solid var(--checkout-border);
            backdrop-filter: blur(20px);
            overflow: hidden;
        }

        .checkout-form-section {
            padding: 40px;
        }

        .checkout-summary-section {
            padding: 30px;
            position: sticky;
            top: 120px;
        }

        .checkout-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .checkout-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .checkout-subtitle {
            color: var(--gray-text);
            font-size: 1.1rem;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .form-section-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section-title::before {
            content: 'üìã';
            font-size: 1.2rem;
        }

        .checkout-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .checkout-form input,
        .checkout-form select {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--light-text);
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .checkout-form input:focus,
        .checkout-form select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.2);
        }

        .checkout-form input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .checkout-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--light-text);
            border: none;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            margin-top: 30px;
        }

        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    
        /* ===== SAVE SHIPPING OPTION ===== */
        .save-shipping-option {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid rgba(255, 107, 53, 0.3);
            border-radius: 8px;
        }
    
        .save-shipping-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--light-text);
            font-weight: 500;
        }
    
        .save-shipping-label input[type="checkbox"] {
            display: none;
        }
    
        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary-color);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s;
        }
    
        .save-shipping-label input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
    
        .save-shipping-label input[type="checkbox"]:checked + .checkmark::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .order-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--secondary-color);
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid var(--primary-color);
        }

        .summary-item-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-item-emoji {
            font-size: 1.2rem;
        }

        .summary-item-details {
            color: var(--gray-text);
            font-size: 0.9rem;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light-text);
            border: 2px solid transparent;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .back-btn:hover {
            border-color: var(--primary-color);
            background: rgba(255, 107, 53, 0.1);
            transform: scale(1.1);
        }

        .checkout-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .checkout-step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-text);
            font-size: 0.9rem;
        }

        .checkout-step.active {
            color: var(--primary-color);
        }

        .checkout-step::before {
            content: '';
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gray-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .checkout-step.active::before {
            background: var(--primary-color);
            color: var(--light-text);
        }

        .checkout-step.completed::before {
            background: var(--success-color);
            content: '‚úì';
        }

        .checkout-step:nth-child(1)::before { content: '1'; }
        .checkout-step:nth-child(2)::before { content: '2'; }
        .checkout-step:nth-child(3)::before { content: '3'; }

        @media (max-width: 768px) {
            .checkout-layout {
                padding: 80px 15px 20px;
            }

            .checkout-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .checkout-summary-section {
                position: static;
                order: -1;
            }

            .checkout-form-section,
            .checkout-summary-section {
                padding: 20px;
            }

            .checkout-title {
                font-size: 2.5rem;
            }

            .checkout-form .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .back-btn {
                top: 10px;
                left: 10px;
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>

    <!-- Background Video -->
    <video class="background-video" autoplay muted loop playsinline>
        <source src="flames.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Back Button -->
    <button class="back-btn" onclick="window.location.href='index.html'" title="Back to Store">
        ‚Üê
    </button>

    <!-- Checkout Layout -->
    <main class="checkout-layout">
        <div class="checkout-container">
            <!-- Checkout Form -->
            <section class="checkout-form-section">
                <header class="checkout-header">
                    <h1 class="checkout-title">Checkout</h1>
                    <p class="checkout-subtitle">Complete your order</p>
                </header>

                <!-- Checkout Steps -->
                <div class="checkout-steps">
                    <div class="checkout-step active">Cart</div>
                    <div class="checkout-step active">Details</div>
                    <div class="checkout-step">Payment</div>
                </div>

                <form class="checkout-form" id="checkoutForm">
                    <!-- Shipping Information -->
                    <div class="form-section">
                        <h2 class="form-section-title">Shipping Information</h2>
                        <div class="form-row">
                            <input type="text" name="firstName" placeholder="First Name">
                            <input type="text" name="lastName" placeholder="Last Name">
                        </div>
                        <input type="email" name="email" placeholder="Email Address">
                        <input type="tel" name="phone" placeholder="Phone Number">
                        <input type="text" name="street" placeholder="Street Address">
                        <div class="form-row">
                            <input type="text" name="city" placeholder="City">
                            <input type="text" name="state" placeholder="State/Province">
                        </div>
                    </div>

                    <!-- Payment Information -->
                    <div class="form-section">
                        <h2 class="form-section-title">Payment Information</h2>
                        <p style="color: var(--gray-text); margin-bottom: 20px;">
                            You'll be redirected to Paystack secure payment gateway to complete your purchase.
                        </p>
                    </div>

                    <!-- Save Shipping Info Option -->
                    <div class="save-shipping-option" id="saveShippingOption" style="display: none;">
                        <label class="save-shipping-label">
                            <input type="checkbox" id="saveShippingInfo" checked>
                            <span class="checkmark"></span>
                            Save this shipping address for future orders
                        </label>
                    </div>

                    <button type="submit" class="checkout-btn" id="checkoutBtn">
                        Proceed to Payment
                    </button>
                </form>
            </section>

            <!-- Order Summary -->
            <section class="checkout-summary-section">
                <div class="order-summary">
                    <h3 class="summary-title">Order Summary</h3>
                    <div class="summary-items" id="summaryItems">
                        <!-- Items will be populated by JavaScript -->
                    </div>
                    <div class="summary-item summary-total">
                        <span>Total:</span>
                        <span id="checkoutTotal">$0.00</span>
                    </div>
                </div>

                <div class="checkout-security">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="color: var(--success-color);">üîí</span>
                        <span style="font-weight: 600;">Secure Checkout</span>
                    </div>
                    <p style="color: var(--gray-text); font-size: 0.9rem; line-height: 1.4;">
                        Your payment information is encrypted and secure. We use Paystack's industry-leading security measures.
                    </p>
                </div>
            </section>
        </div>
    </main>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
        <div class="success-content">
            <span class="success-icon">‚úì</span>
            <p>Order placed successfully!</p>
        </div>
    </div>

    <!-- Load Configuration and Scripts -->
    <script src="config.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        // Preloader
        document.addEventListener('DOMContentLoaded', () => {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                setTimeout(() => {
                    preloader.classList.add('hidden');
                }, 1500);
            }
        });
        // ===== PRODUCTS DATA =====
        let productsList = [];

        async function fetchProducts() {
            try {
                const response = await apiCall(API_ENDPOINTS.getAllProducts);
                if (response.success) {
                    productsList = response.products;
                }
            } catch (error) {
                console.error('Failed to fetch products:', error);
            }
        }

        // ===== CART STATE =====
        let cart = JSON.parse(localStorage.getItem('lighterPooaCart')) || [];

        // ===== DOM ELEMENTS =====
        let checkoutForm, summaryItems, checkoutTotal, checkoutBtn, successMessage;

        // ===== INITIALIZE CHECKOUT =====
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize DOM elements
            checkoutForm = document.getElementById('checkoutForm');
            summaryItems = document.getElementById('summaryItems');
            checkoutTotal = document.getElementById('checkoutTotal');
            checkoutBtn = document.getElementById('checkoutBtn');
            successMessage = document.getElementById('successMessage');

            // Add form submit event listener
            checkoutForm.addEventListener('submit', handleCheckoutSubmit);
            // Check if user is logged in
            const token = getAuthToken();
            if (!token) {
                alert('Please login to checkout');
                window.location.href = 'login.html';
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty');
                window.location.href = 'index.html';
                return;
            }

            // Fetch products first
            await fetchProducts();
            
            updateOrderSummary();
            
            // Disable checkout button while loading user data
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'Loading your information...';
            
            await loadUserData();
            
            // Re-enable checkout button after data is loaded
            checkoutBtn.disabled = false;
            checkoutBtn.textContent = 'Proceed to Payment';
        });

        // ===== UPDATE ORDER SUMMARY =====
        function updateOrderSummary() {
            if (cart.length === 0) {
                summaryItems.innerHTML = '<p style="text-align: center; color: var(--gray-text);">No items in cart</p>';
                checkoutTotal.textContent = 'Ksh 0';
                return;
            }

            // Ensure cart items have all necessary properties by matching with products array
            const validatedCart = cart.map(item => {
                const productId = item._id || item.id;
                const product = productsList.find(p => p._id === productId);
                if (product) {
                    // If product is found, merge with cart item (preserve quantity)
                    return {
                        ...product,
                        quantity: item.quantity
                    };
                }
                // If product not found, keep the item but set defaults
                return {
                    ...item,
                    _id: productId,
                    name: item.name || 'Unidentified Product',
                    price: item.price || 0,
                    emoji: item.emoji || 'üì¶',
                    image: (item.images && item.images[0]) || item.image || ''
                };
            });

            summaryItems.innerHTML = validatedCart.map(item => `
                <div class="summary-item">
                    <div class="summary-item-name">
                        <img src="${item.images && item.images[0] ? item.images[0] : item.image ? item.image : 'https://via.placeholder.com/60?text=No+Image'}" alt="${item.name}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                        <div>
                            <div>${item.name}</div>
                            <div class="summary-item-details">Qty: ${item.quantity}</div>
                        </div>
                    </div>
                    <span>Ksh ${(item.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('');

            const total = validatedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            checkoutTotal.textContent = `Ksh ${total.toLocaleString()}`;
        }

        // ===== HANDLE CHECKOUT =====
        async function handleCheckoutSubmit(e) {
            e.preventDefault();
            
            // Get the submit button (not the form)
            const submitButton = checkoutBtn;
            
            // Check if already processing
            if (submitButton.classList.contains('is-loading')) return;
            
            // Set button to loading state
            submitButton.classList.add('is-loading');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner"></span> Processing...';

            // Debug: Check if form elements exist
            console.log('üîç Checking form elements...');
            console.log('Form:', checkoutForm);
            console.log('First Name Input:', checkoutForm.querySelector('[name="firstName"]'));
            console.log('First Name Value:', checkoutForm.querySelector('[name="firstName"]')?.value);

            // Get values directly from form inputs instead of FormData
            const shippingInfo = {
                firstName: (checkoutForm.querySelector('[name="firstName"]')?.value || '').trim(),
                lastName: (checkoutForm.querySelector('[name="lastName"]')?.value || '').trim(),
                email: (checkoutForm.querySelector('[name="email"]')?.value || '').trim(),
                phone: (checkoutForm.querySelector('[name="phone"]')?.value || '').trim(),
                street: (checkoutForm.querySelector('[name="street"]')?.value || '').trim(),
                city: (checkoutForm.querySelector('[name="city"]')?.value || '').trim(),
                state: (checkoutForm.querySelector('[name="state"]')?.value || '').trim()
            };

            console.log('üìã Form data collected:', shippingInfo);

            // Validate required fields (check for non-empty strings after trimming)
            const requiredFields = {
                firstName: 'First Name',
                lastName: 'Last Name',
                email: 'Email Address',
                phone: 'Phone Number',
                street: 'Street Address',
                city: 'City',
                state: 'State/Province'
            };
            
            const missingFields = Object.keys(requiredFields).filter(field => 
                !shippingInfo[field] || shippingInfo[field].length === 0
            );

            if (missingFields.length > 0) {
                console.log('‚ùå Missing fields:', missingFields);
                const fieldNames = missingFields.map(field => requiredFields[field]);
                showNotification(`Please fill in all required fields: ${fieldNames.join(', ')}`, 'error');
                // Reset button state
                submitButton.classList.remove('is-loading');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Proceed to Payment';
                return;
            }


            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(shippingInfo.email)) {
                showNotification('Please enter a valid email address', 'error');
                // Reset button state
                submitButton.classList.remove('is-loading');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Proceed to Payment';
                return;
            }

            // Check if user wants to save shipping info
            const saveShippingInfo = document.getElementById('saveShippingInfo').checked;

            if (saveShippingInfo) {
                try {
                    // Save shipping info to user profile
                    await apiCall(API_ENDPOINTS.updateProfile, {
                        method: 'PUT',
                        body: JSON.stringify({
                            firstName: shippingInfo.firstName,
                            lastName: shippingInfo.lastName,
                            phone: shippingInfo.phone,
                            address: {
                                street: shippingInfo.street,
                                city: shippingInfo.city,
                                state: shippingInfo.state
                            }
                        })
                    });
                    console.log('‚úÖ Shipping address saved successfully');
                    showNotification('Shipping address saved for future orders!');
                } catch (error) {
                    console.error('‚ùå Failed to save shipping info:', error);
                    // Don't block checkout if saving fails
                }
            }

            // Product data (same as in script.js)
            const products = [
                {
                    id: 1,
                    name: "Classic Zippo Lighter",
                    category: "lighters",
                    price: 3899,
                    description: "Iconic windproof lighter with lifetime guarantee",
                    images: ["https://www.hansonellis.com/mm5/graphics/00000001/engraved-silver-polished-classic-zippo-lighter.jpg", "https://www.zippo.com/cdn/shop/products/zau89ndsgta0yvs3nprh.jpg?v=1744725583&width=1445", "https://assets.katogroup.eu/i/katogroup/ZP250-023085_01_zippo"],
                    video: "flames.mp4",
                    emoji: "üî•"
                },
                {
                    id: 2,
                    name: "Torch Lighter Pro",
                    category: "lighters",
                    price: 5199,
                    description: "Professional grade torch lighter with adjustable flame",
                    images: ["https://www.greenlion.net/web/image/315624-38c1bc5d/Green%20Lion%20Jet%20Flame%20Pro%20Windproof%20Lighter%20-%20Black%20%282%29.webp", "https://sc04.alicdn.com/kf/H406dd289a52a4ba2b8a62ce58fd9a2fbv.jpg"],
                    video: "flames.mp4",
                    emoji: "üî•"
                },
                {
                    id: 3,
                    name: "Electric Arc Lighter",
                    category: "lighters",
                    price: 3249,
                    description: "USB rechargeable plasma arc lighter",
                    images: ["https://m.media-amazon.com/images/I/519Yri1MxPL._UF1000,1000_QL80_.jpg", "https://m.media-amazon.com/images/I/61QTYr-g2HL.jpg"],
                    video: "flames.mp4",
                    emoji: "‚ö°"
                },
                {
                    id: 4,
                    name: "Premium Rolling Papers",
                    category: "accessories",
                    price: 649,
                    description: "Ultra-thin slow-burn rolling papers (50 pack)",
                    images: ["https://image.made-in-china.com/202f0j00cNzQCRpaaZrK/14GSM-Make-Your-Own-Brand-Classic-Type-Unbleached-Cigarette-Rolling-Paper-with-Filter-Tips-Package.webp", "https://image.made-in-china.com/202f0j00aosiNztnEOkI/Premium-Cigarette-Rolling-Papers-with-Tips-single-1-1-4-kingslim-size-.webp"],
                    video: "flames.mp4",
                    emoji: "üìÑ"
                },
                {
                    id: 5,
                    name: "Grinder Deluxe",
                    category: "accessories",
                    price: 2599,
                    description: "4-piece aluminum grinder with pollen catcher",
                    images: ["https://powerhouseexpress.com.pk/cdn/shop/files/anex-ag-639-deluxe-grinder-1.webp?v=1747308208&width=1445", "https://nazarjanssupermarket.com/cdn/shop/files/anex-deluxe-grinder-ag-632-nazar-jan-s-supermarket-2.jpg?v=1715281294"],
                    video: "flames.mp4",
                    emoji: "‚öôÔ∏è"
                },
                {
                    id: 6,
                    name: "Glass Ashtray",
                    category: "accessories",
                    price: 1949,
                    description: "Heavy-duty crystal glass ashtray",
                    images: ["https://m.media-amazon.com/images/I/51xIA3As5ZL._UF1000,1000_QL80_.jpg", "https://m.media-amazon.com/images/I/61XiEbe55sL._UF1000,1000_QL80_.jpg"],
                    video: "flames.mp4",
                    emoji: "üö¨"
                },
                {
                    id: 7,
                    name: "Portable Vaporizer",
                    category: "gadgets",
                    price: 11699,
                    description: "Compact dry herb vaporizer with temperature control",
                    images: ["https://www.vapor.com/cdn/shop/files/9284486_ef9b251a-d168-42dd-b53c-cc4a67a2f938.png?v=1689910145&width=533", "https://cdn.shopify.com/s/files/1/0083/3817/8111/collections/shop-portable-vaporizers.jpg?v=1739396445"],
                    video: "flames.mp4",
                    emoji: "üí®"
                },
                {
                    id: 8,
                    name: "LED Lighter Display",
                    category: "gadgets",
                    price: 4549,
                    description: "Rechargeable lighter with LED display",
                    images: ["https://www.awelled.com/wp-content/uploads/sites/8/2021/10/LED-Revolving-Ligh-for-jewelry-display-t-AW-RL1120-3-smaller-600x600.jpg", "https://i.ytimg.com/vi/VFALE_lYEyQ/sddefault.jpg"],
                    video: "flames.mp4",
                    emoji: "üí°"
                },
                {
                    id: 9,
                    name: "Smoking Pipe Set",
                    category: "accessories",
                    price: 5849,
                    description: "Premium wooden pipe with cleaning kit",
                    images: ["https://i.ebayimg.com/images/g/TDYAAOSw3EFjQZ4i/s-l1200.png", "https://i.ebayimg.com/images/g/lj4AAeSwbaln~Pl4/s-l1200.jpg"],
                    video: "flames.mp4",
                    emoji: " üö¨"
                },
                {
                    id: 10,
                    name: "Butane Refill Pack",
                    category: "accessories",
                    price: 1689,
                    description: "Premium butane fuel (3 pack)",
                    images: ["https://image.made-in-china.com/2f0j00fsVhJtdnZTGl/150ml-Butane-Gas-Can-96-Pack-Universal-Gas-Lighter-Refill-Can-Refillable-Butane-Gas.webp", "https://images-na.ssl-images-amazon.com/images/I/81tnULKtwpL._AC_UL495_SR435,495_.jpg"],
                    video: "flames.mp4",
                    emoji: "‚õΩ"
                },
                {
                    id: 11,
                    name: "Gold Plated Lighter",
                    category: "lighters",
                    price: 10399,
                    description: "Luxury gold-plated lighter with engraving",
                    images: ["https://i.redd.it/q36ksr30m27c1.jpeg", "https://lightersdirect.com/cdn/shop/files/DU24RRR5101710TU-3_1400x.jpg?v=1708963033"],
                    video: "flames.mp4",
                    emoji: "‚ú®"
                },
                {
                    id: 12,
                    name: "Smart Lighter Case",
                    category: "gadgets",
                    price: 3899,
                    description: "Protective case with built-in tracker",
                    images: ["https://img.drz.lazcdn.com/static/bd/p/d6383feb5b2ac5ab19f157159d61c405.jpg_720x720q80.jpg", "https://m.media-amazon.com/images/I/51jV7M4vUIL.jpg"],
                    video: "flames.mp4",
                    emoji: "üì±"
                }
            ];

            const validatedCart = cart.map(item => {
                const product = products.find(p => p.id === item.id);
                return product ? { ...product, quantity: item.quantity } : item;
            });

            const total = validatedCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            // Prepare order data
            const orderData = {
                items: validatedCart.map(item => ({
                    productId: item.id || item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    image: item.images && item.images[0] ? item.images[0] : item.image ? item.image : 'https://via.placeholder.com/150?text=No+Image'
                })),
                totalAmount: total,
                shippingInfo: shippingInfo
            };

            try {
                console.log('üì¶ Order Data:', orderData);
                console.log('üí≥ Initializing payment - Email:', shippingInfo.email, 'Amount:', total);

                // Initialize Paystack payment
                const response = await apiCall(API_ENDPOINTS.initializePayment, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: shippingInfo.email.trim(),
                        amount: total,
                        orderData: orderData
                    })
                });

                if (response.success) {
                    console.log('‚úÖ Payment initialized successfully');
                    
                    // Initialize Paystack popup
                    const handler = PaystackPop.setup({
                        key: PAYSTACK_PUBLIC_KEY,
                        email: shippingInfo.email,
                        amount: Math.round(total * 100), // Convert to kobo
                        currency: 'KES',
                        ref: response.data.reference,
                        callback: function(paystackResponse) {
                            console.log('üí∞ Payment completed, reference:', paystackResponse.reference);
                            handlePaymentSuccess(paystackResponse.reference, orderData).catch(error => {
                                console.error('Error in payment success handler:', error);
                                showNotification('Payment processing failed. Please contact support.', 'error');
                            });
                        },
                        onClose: function() {
                            showNotification('Payment cancelled', 'error');
                            // Reset button state
                            submitButton.classList.remove('is-loading');
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'Proceed to Payment';
                        }
                    });

                    handler.openIframe();
                } else {
                    throw new Error(response.message || 'Payment initialization failed');
                }
            } catch (error) {
                console.error('‚ùå Payment initialization error:', error);
                showNotification(error.message || 'Payment initialization failed. Please try again.', 'error');
                // Reset button state
                submitButton.classList.remove('is-loading');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Proceed to Payment';
            }
        }

        // ===== HANDLE PAYMENT SUCCESS =====
        async function handlePaymentSuccess(reference, orderData) {
            try {
                console.log('üîç Verifying payment...');
                
                // Verify payment
                const verifyResponse = await apiCall(API_ENDPOINTS.verifyPayment(reference));
                console.log('üìã Verification response:', verifyResponse);

                if (verifyResponse.success && verifyResponse.data.status === 'success') {
                    console.log('‚úÖ Payment verified successfully');
                    console.log('üìù Creating order in database...');
                    
                    // Create order in database
                    const orderResponse = await apiCall(API_ENDPOINTS.createOrder, {
                        method: 'POST',
                        body: JSON.stringify({
                            ...orderData,
                            paymentReference: reference
                        })
                    });
                    
                    console.log('üì¶ Order creation response:', orderResponse);

                    if (orderResponse.success) {
                        console.log('‚úÖ Order created successfully:', orderResponse.order._id);
                        console.log('üí≥ Updating payment status...');
                        
                        // Update order payment status
                        await apiCall(API_ENDPOINTS.updatePayment(orderResponse.order._id), {
                            method: 'PUT',
                            body: JSON.stringify({
                                status: 'success',
                                paidAt: new Date().toISOString()
                            })
                        });
                        
                        console.log('‚úÖ Payment status updated');

                        // Clear cart
                        cart = [];
                        localStorage.setItem('lighterPooaCart', JSON.stringify(cart));
                        console.log('üõí Cart cleared');

                        // Show success message
                        showSuccessMessage();

                        // Redirect to dashboard after 2 seconds
                        setTimeout(() => {
                            console.log('üîÑ Redirecting to dashboard...');
                            window.location.href = 'dashboard.html';
                        }, 2000);
                    } else {
                        throw new Error(orderResponse.message || 'Failed to create order');
                    }
                } else {
                    console.error('‚ùå Payment verification failed:', verifyResponse);
                    showNotification('Payment verification failed. Please contact support.', 'error');
                }
            } catch (error) {
                console.error('‚ùå Order creation error:', error);
                showNotification(error.message || 'Failed to create order. Please contact support.', 'error');
            }
        }

        // ===== SHOW SUCCESS MESSAGE =====
        function showSuccessMessage() {
            successMessage.classList.add('active');
            setTimeout(() => {
                successMessage.classList.remove('active');
            }, 3000);
        }

        // ===== LOAD USER DATA =====
        async function loadUserData() {
            try {
                const userData = await apiCall(API_ENDPOINTS.getUser);
                if (userData.success && userData.user) {
                    const user = userData.user;
                    console.log('‚úÖ User data loaded:', user);

                    // Prefill basic user info
                    const form = document.getElementById('checkoutForm');

                    // Handle firstName and lastName (use separate fields if available, otherwise split name)
                    if (user.firstName && user.firstName.trim()) {
                        form.querySelector('[name="firstName"]').value = user.firstName.trim();
                    } else if (user.name && user.name.trim()) {
                        const nameParts = user.name.trim().split(/\s+/);
                        form.querySelector('[name="firstName"]').value = nameParts[0] || '';
                    }

                    if (user.lastName && user.lastName.trim()) {
                        form.querySelector('[name="lastName"]').value = user.lastName.trim();
                    } else if (user.name && user.name.trim()) {
                        const nameParts = user.name.trim().split(/\s+/);
                        form.querySelector('[name="lastName"]').value = nameParts.slice(1).join(' ') || '';
                    }

                    if (user.email && user.email.trim()) form.querySelector('[name="email"]').value = user.email.trim();
                    if (user.phone && user.phone.trim()) form.querySelector('[name="phone"]').value = user.phone.trim();

                    console.log('üîç Verifying populated values:');
                    console.log('First Name:', form.querySelector('[name="firstName"]').value);
                    console.log('Last Name:', form.querySelector('[name="lastName"]').value);
                    console.log('Email:', form.querySelector('[name="email"]').value);
                    console.log('Phone:', form.querySelector('[name="phone"]').value);

                    // Check if user has saved address
                    const hasSavedAddress = user.address &&
                        (user.address.street && user.address.street.trim()) &&
                        (user.address.city && user.address.city.trim()) &&
                        (user.address.state && user.address.state.trim());

                    if (hasSavedAddress) {
                        // Prefill saved address
                        if (user.address.street) form.querySelector('[name="street"]').value = user.address.street.trim();
                        if (user.address.city) form.querySelector('[name="city"]').value = user.address.city.trim();
                        if (user.address.state) form.querySelector('[name="state"]').value = user.address.state.trim();

                        // Hide save option since they already have saved address
                        document.getElementById('saveShippingOption').style.display = 'none';
                    } else {
                        // Show save option for new users
                        document.getElementById('saveShippingOption').style.display = 'block';
                    }

                    console.log('‚úÖ Form fields populated successfully');
                }
            } catch (error) {
                console.error('‚ùå Failed to load user data:', error);
                // Show save option if we can't load user data
                document.getElementById('saveShippingOption').style.display = 'block';
            }
        }

        // ===== SHOW NOTIFICATION =====
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const icon = type === 'error' ? '‚úó' : '‚úì';
            const bgColor = type === 'error' ? 'var(--danger-color)' : 'var(--success-color)';

            notification.className = 'success-message active';
            notification.style.background = bgColor;
            notification.innerHTML = `
                <div class="success-content">
                    <span class="success-icon">${icon}</span>
                    <p>${message}</p>
                </div>
            `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ===== UTILITY FUNCTIONS =====
        function beginButtonAction(e) {
            const button = e.target;
            if (button.classList.contains('is-loading')) return false;

            button.classList.add('is-loading');
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span> Processing...';
            return true;
        }

        function endButtonAction(e) {
            const button = e.target;
            button.classList.remove('is-loading');
            button.disabled = false;
            button.innerHTML = 'Proceed to Payment';
        }
    </script>
</body>
</html>